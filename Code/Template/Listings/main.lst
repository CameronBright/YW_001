C51 COMPILER V9.57.0.0   MAIN                                                              09/28/2024 22:48:09 PAGE 1   


C51 COMPILER V9.57.0.0, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN .\Objects\main.obj
COMPILER INVOKED BY: D:\Software\WorkSoftware\Keil5\C51\C51\BIN\C51.EXE User\main.c OPTIMIZE(8,SPEED) BROWSE INCDIR(.\Us
                    -er;.\Hardware;.\Startup;.\Readme) DEBUG OBJECTEXTEND PRINT(.\Listings\main.lst) TABS(2) OBJECT(.\Objects\main.obj)

line level    source

   1          /*
   2          
   3          Version: 0.0.0
   4          Check out the Readme.txt for more details 
   5           
   6          */
   7           
   8          //系统库
   9          #include "main.h"
  10          #include <stdio.h>
  11          
  12          //外设库
  13          #include "gpio.h"
  14          #include "timer.h"
  15          #include "key.h"
  16          #include "seg.h"
  17          //#include "eeprom.h"
  18          #include "config.h"
  19          
  20          //-----------功能选择区-----------
  21          
  22          
  23          //程序执行函数
  24          void Key_Proc(void);       //Keystroke process function
  25          void Disp_Proc(void);      //LCD Dsiplay process function
  26          
  27          //自定义功能函数 
  28          void Delay(unsigned int delay); //定时器延时 会卡住当前函数，但不会影响整个代码
  29          void Peripheral_Init(void);//外设初始化函数
  30          
  31          //----------------可能需要修改的变量-------------------------------------
  32          
  33          //刷新计数,按键10ms扫描一次,数码管200ms刷新一次
  34          u16 key_slow_down = 0; //按键刷新计数
  35          u16 disp_slow_down = 0; //显示刷新计数
  36          
  37          /*按键相关变量*/
  38          u16 key_tick;        //long key press count
  39          bit key_sw = 1;
  40          bit keylong = 1;
  41          
  42          u8 key_value = 0;       //按键值
  43          u8 key_down;            //按键下降沿
  44          u8 key_up;              //上升沿
  45          u8 key_old;             //上次的按键值
  46          
  47          u16 delay_tick;         //软件延时计数
  48          
  49          /*数码管显示相关变量*/
  50          char seg_string[2];     //数码管显示字符串
  51          char seg_buf[2];        //数码管显示缓冲区
  52          
  53          u8 seg_buf2;            //按键下LED控制 0b0011 1111 1为亮 0为灭
  54          u8 pos1 = 0;              //数码管段选
C51 COMPILER V9.57.0.0   MAIN                                                              09/28/2024 22:48:09 PAGE 2   

  55          u8 pos2 = 0;              //数码管段选
  56          
  57          /*外设相关变量*/
  58          u16 buzzer_tick;        //蜂鸣器短响计数
  59          
  60          void main(){
  61   1        GPIO_Init();      //引脚初始化
  62   1        Timer1_Init();    //定时器初始化
  63   1        EA = 1;           //打开总中断
  64   1        Config_Init();    //初始化配置
  65   1        Peripheral_Init();//外设函数初始状态
  66   1        
  67   1        while(1)
  68   1        {
  69   2          Key_Proc();
  70   2          Disp_Proc();
  71   2          LED1 = 0;
  72   2          LED2 = 0;
  73   2          LED3 = 0;   
  74   2          
  75   2          //ADIG1 = 1;
  76   2          ADIG2 = 1;
  77   2          ADIG3 = 1;
  78   2          ADIG4 = 1;
  79   2        
  80   2          BDIG1 = 1;
  81   2          BDIG2 = 1;
  82   2          BDIG3 = 1;
  83   2          BDIG4 = 1;
  84   2        
  85   2          LED1A = 0;
  86   2          LED1B = 0;
  87   2          LED1C = 0;
  88   2          LED1D = 0;
  89   2          LED1E = 0;
  90   2          LED1F = 0;
  91   2          LED1G = 0;
  92   2          LED1DP = 0;
  93   2        
  94   2        LED2A = 0;
  95   2        LED2B = 0;
  96   2        LED2C = 0;
  97   2        LED2D = 0;
  98   2        LED2E = 0;
  99   2        LED2F = 0;
 100   2        LED2G = 0;
 101   2        LED2DP = 0;
 102   2        }
 103   1      } 
 104          
 105          //================中断函数=======================
 106          void Timer1_Isr(void) interrupt 3   //1ms 中断一次
 107          {
 108   1        //本中断函数内全是赋值，没有运算，每次中断时间不会过长
 109   1        if(++key_slow_down == 10) key_slow_down = 0;   //10ms扫描一次按键
 110   1        if(++disp_slow_down == 200) disp_slow_down = 0;//200ms刷新一次数码管
 111   1         
 112   1      //--------------------1s定时器---------------------------
 113   1        
 114   1      
 115   1      //--------------------外设控制---------------------------
 116   1        
C51 COMPILER V9.57.0.0   MAIN                                                              09/28/2024 22:48:09 PAGE 3   

 117   1        //按键长短按计时
 118   1        if(key_tick > 0) key_tick--;  
 119   1          
 120   1        //软件延时
 121   1        if(delay_tick > 0) delay_tick--;//延时函数 使用会卡住当前函数，但不影响其他功能
 122   1          
 123   1        //数码管段选刷新
 124   1      //  Seg_Disp(seg_buf,pwm_index,seg_buf2,pos);
 125   1        if(++pos1 > 3) pos1 = 0;
 126   1        if(++pos2 > 3) pos2 = 0;
 127   1      }
 128          
 129          //================按键逻辑函数=======================
 130          void Key_Proc(void)        //Keystroke process function
 131          {
 132   1        if(key_slow_down) return;   //10ms进入一次此函数
 133   1          key_slow_down = 1;
 134   1          
 135   1        key_value = Key_Scan(); //读取键值 强制消抖
 136   1        key_down = key_value & (key_value ^ key_old); //下降沿
 137   1        key_up = ~key_value & (key_value ^ key_old);  //上升沿
 138   1        key_old = key_value;
 139   1        
 140   1        if(key_down)       //长按3秒
 141   1          key_tick = 3000;
 142   1        
 143   1         //key_old键值 tick按下计数  long自锁，保证按键代码只触发一次
 144   1        if(key_old && key_tick == 0 && keylong){
 145   2          keylong = 0;    
 146   2          if(key_old == 1){     //长按童锁键    
 147   3            //------按键1长按功能--------
 148   3            
 149   3            //------按键1长按功能--------       
 150   3          }
 151   2          if(key_old == 4){ //长按磁化键  
 152   3            //------按键4长按功能--------
 153   3      
 154   3            //------按键4长按功能--------   
 155   3          }
 156   2        }
 157   1        
 158   1        if(key_up) //keydown-keyup顺序不能更改
 159   1          keylong = 1;
 160   1        
 161   1        if(key_tick && key_sw){
 162   2          switch(key_up)
 163   2          {
 164   3            case 1://锁键1
 165   3            {     
 166   4              ADIG1 ^=1;
 167   4              break;
 168   4            }
 169   3            case 2://按键2
 170   3            {
 171   4              LED2 ^= 1;
 172   4              break;
 173   4            }
 174   3            case 3://按键3
 175   3            {
 176   4              LED3 ^= 1;
 177   4              break;
 178   4            }
C51 COMPILER V9.57.0.0   MAIN                                                              09/28/2024 22:48:09 PAGE 4   

 179   3            case 4://按键4
 180   3            {             
 181   4              break;                             
 182   4            }                                    
 183   3            default:                             
 184   3              break;
 185   3          }
 186   2        }
 187   1          
 188   1      }
 189          
 190          //================显示逻辑函数=======================
 191          void Disp_Proc(void)       //LCD Dsiplay process function
 192          {
 193   1        if(disp_slow_down) return;   //200ms进入一次此函数(200ms刷新一次屏幕)
 194   1          disp_slow_down = 1;
 195   1        
 196   1        
 197   1      //  sprintf(seg_string,"%02d",(unsigned int)save_flag); //调试
 198   1          
 199   1      //  sprintf(seg_string,"%2d",(unsigned int)Mode);//显示模式 1=高原模式，出水85°，0=普通模式，出水93°
 200   1        
 201   1      //  Led_Trans(seg_string,seg_buf);
 202   1          
 203   1        
 204   1        
 205   1      }
 206          
 207          //================自定义函数=======================
 208          
 209          //定时器延时 会卡住当前函数，但不会影响整个代码
 210          void Delay(unsigned int delay) 
 211          {
 212   1        delay_tick = delay;
 213   1        while(delay_tick > 0);
 214   1      }
 215          
 216          /*
 217          tick: 蜂鸣器响的时间ms
 218          */
 219          void Buzzer_Ctrl(u16 tick)  
 220          {
 221   1        buzzer_tick = tick;
 222   1      }
 223          
 224          void Peripheral_Init(void)//外设初始化函数
 225          {
 226   1        Buzzer_Ctrl(200);//上电短响200ms一次
 227   1        seg_buf2 = 0x30;
 228   1       
 229   1      }
 230          


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    330    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     21    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =      2    ----
C51 COMPILER V9.57.0.0   MAIN                                                              09/28/2024 22:48:09 PAGE 5   

END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
