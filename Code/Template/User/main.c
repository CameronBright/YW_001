/*

Version: 1.0.1
Check out the Readme.txt for more details 
 
*/
 
//ÏµÍ³¿â
#include "main.h"
#include <stdio.h>

//ÍâÉè¿â
#include "gpio.h"
#include "timer.h"
#include "key.h"
#include "seg.h"
#include "uart.h"
//#include "eeprom.h"
#include "config.h"

//-----------¹¦ÄÜÑ¡ÔñÇø-----------


//³ÌÐòÖ´ÐÐº¯Êý
void Key_Proc(void);   	   //Keystroke process function
void Disp_Proc(void);  	   //LCD Dsiplay process function

//×Ô¶¨Òå¹¦ÄÜº¯Êý
void Delay(unsigned int delay); //¶¨Ê±Æ÷ÑÓÊ± »á¿¨×¡µ±Ç°º¯Êý£¬µ«²»»áÓ°ÏìÕû¸ö´úÂë
void Peripheral_Init(void);//ÍâÉè³õÊ¼»¯º¯Êý

void UART2_config(u8 brt);   // ï¿?0ï¿?5ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7, 2: ï¿?0ï¿?0ï¿?1ï¿?7ï¿?1ï¿?7Timer2ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7, ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?0ï¿?5: ï¿?1ï¿?7ï¿?1ï¿?7å®?.
void PrintString2(u8 *puts);

//----------------ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?0ï¿?8ï¿?1ï¿?7ï¿?1ï¿?0ï¿?0ï¿?7ï¿?0ï¿?3ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7-------------------------------------

//ï¿?0ï¿?6ï¿?1ï¿?7ï¿?0ï¿?4ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7,ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?710msï¿?0ï¿?9ï¿?1ï¿?7ï¿?1ï¿?7ï¿?0ï¿?5ï¿?1ï¿?7ï¿?1ï¿?7,ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7200msï¿?0ï¿?6ï¿?1ï¿?7ï¿?1ï¿?7ï¿?0ï¿?5ï¿?1ï¿?7ï¿?1ï¿?7
u16 key_slow_down = 0; //ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?0ï¿?6ï¿?1ï¿?7ï¿?0ï¿?4ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7
u16 disp_slow_down = 0; //ï¿?1ï¿?7ï¿?1ï¿?7ï¿?0ï¿?5ï¿?0ï¿?6ï¿?1ï¿?7ï¿?0ï¿?4ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7

/*ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?9ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7*/
u16 key_tick; 		   //long key press count
bit key_sw = 1;
bit keylong = 1;

u8 key_value = 0;				//ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?0ï¿?5
u8 key_down;		 				//ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?0ï¿?5ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7
u8 key_up;   		 				//ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7
u8 key_old;  		 				//ï¿?1ï¿?7ï¿?0ï¿?2æ±ï¿½0ï¿?2ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?0ï¿?5

u16 delay_tick;         //ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?0ï¿?2ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7

/*ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?0ï¿?5ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?9ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7*/
char seg_string[4];			//ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?0ï¿?5ï¿?1ï¿?7ï¿?0ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7
char seg_buf1[4];				//ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?71ï¿?1ï¿?7ï¿?1ï¿?7ï¿?0ï¿?5ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7
char seg_buf2[4];				//ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?72ï¿?1ï¿?7ï¿?1ï¿?7ï¿?0ï¿?5ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7

u8 LED_buf;						//ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7LEDï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7 0b0011 1111 1ï¿?0ï¿?2ï¿?1ï¿?7ï¿?1ï¿?7 0ï¿?0ï¿?2ï¿?1ï¿?7ï¿?1ï¿?7
u8 pos = 0;  						//ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?0ï¿?1ï¿?7ï¿?0ï¿?5

/*ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?9ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7*/
u8  TX2_Cnt;    //ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?0ï¿?0ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7
u8  RX2_Cnt;    //ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?0ï¿?8ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7
bit B_TX2_Busy; //ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?0ï¿?3ï¿?1ï¿?7ï¿?1ï¿?7ï¿?0ï¿?4

u8  xdata RX2_Buffer[UART2_BUF_LENGTH]; //ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?0ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7

/*ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?9ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7*/
u16 buzzer_tick;        //ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7

/*ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?0ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7*/
u8 mode;                //ï¿?0ï¿?0ï¿?0ï¿?4ï¿?1ï¿?7æŠ–ï¿½1ï¿?7

void main(){
	GPIO_Init();			//ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?0ï¿?5ï¿?1ï¿?7ï¿?0ï¿?3ï¿?1ï¿?7ï¿?1ï¿?
	Timer1_Init();		//ï¿?1ï¿?7ï¿?1ï¿?7ï¿?0ï¿?2ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?0ï¿?3ï¿?1ï¿?7ï¿?1ï¿?7
	UART2_config(2);  // ï¿?0ï¿?5ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7, 2: ï¿?0ï¿?0ï¿?1ï¿?7ï¿?1ï¿?7Timer2ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7, ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?0ï¿?5: ï¿?1ï¿?7ï¿?1ï¿?7å®?.
	EA = 1;         	//ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7å¿?ï¿?1ï¿?7
	Config_Init();  	//ï¿?1ï¿?7ï¿?1ï¿?7ï¿?0ï¿?3ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7
	Peripheral_Init();//ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7Ð—ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?0ï¿?3ï¿?0ï¿?8ï¿?0ï¿?0
	
	PrintString2("STC8H8K64U UART2 Test Programme!\r\n");  //UART2ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?0ï¿?5ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?0ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7
	
	while(1)
	{
		        if((TX2_Cnt != RX2_Cnt) && (!B_TX2_Busy))   //ï¿?1ï¿?7ï¿?0ï¿?1ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7, ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?0ï¿?3ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7
        {
            S2BUF = RX2_Buffer[TX2_Cnt];
            B_TX2_Busy = 1;
            if(++TX2_Cnt >= UART2_BUF_LENGTH)   TX2_Cnt = 0;
        }
		
		
		Key_Proc();
		Disp_Proc();
		LED1 = 0;
		LED2 = 0;
		LED3 = 0;		
		
	}
} 

//================ï¿?1ï¿?7å¿?ï¿?0ï¿?8ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7=======================
void Timer1_Isr(void) interrupt 3   //1ms ï¿?1ï¿?7å¿?ï¿?1ï¿?7ï¿?0ï¿?5ï¿?1ï¿?7ï¿?1ï¿?7
{
	//ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7å¿?ï¿?0ï¿?8ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?0ï¿?0ï¿?1ï¿?7ï¿?0ï¿?0ï¿?1ï¿?7ï¿?0ï¿?5ï¿?1ï¿?7ï¿?1ï¿?7ï¿?0ï¿?4ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?0ï¿?4ï¿?0ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7å¿?ï¿?1ï¿?7ï¿?0ï¿?2ï¿?1ï¿?7ï¿?4ï¿?6ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7
	if(++key_slow_down == 10) key_slow_down = 0;   //10msï¿?0ï¿?9ï¿?1ï¿?7ï¿?1ï¿?7ï¿?0ï¿?5ï¿?1ï¿?7ï¿?0ï¿?8ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7
	if(++disp_slow_down == 200) disp_slow_down = 0;//200msï¿?0ï¿?6ï¿?1ï¿?7ï¿?1ï¿?7ï¿?0ï¿?5ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7
	 
//--------------------1sï¿?1ï¿?7ï¿?1ï¿?7ï¿?0ï¿?2ï¿?1ï¿?7ï¿?1ï¿?7---------------------------
	

//--------------------ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7---------------------------
	
	//ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?0ï¿?4ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?0ï¿?2
	if(key_tick > 0) key_tick--;  
		
	//ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?0ï¿?2
	if(delay_tick > 0) delay_tick--;//ï¿?1ï¿?7ï¿?1ï¿?7ï¿?0ï¿?2ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7 ï¿?0ï¿?0ï¿?1ï¿?7ï¿?0ï¿?4ï¿?6ï¿?2ï¿?0ï¿?9ï¿?1ï¿?7ï¿?1ï¿?7ï¿?0ï¿?2ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?0ï¿?8ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7
		
	//ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?0ï¿?1ï¿?7ï¿?0ï¿?5ï¿?0ï¿?6ï¿?1ï¿?7ï¿?1ï¿?7

	Seg_Disp1(seg_buf1,pos);
	Seg_Disp2(seg_buf2,pos);
	if(++pos > 3) pos = 0;
}

//================ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?8ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7=======================
void Key_Proc(void)   	   //Keystroke process function
{
	if(key_slow_down) return;   //10msï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?0ï¿?5ï¿?1ï¿?7æ±›ï¿½0ï¿?0ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7
		key_slow_down = 1;
		
	key_value = Key_Scan(); //ï¿?1ï¿?7ï¿?1ï¿?7ï¿?0ï¿?0ï¿?1ï¿?7ï¿?1ï¿?7ï¿?0ï¿?5 ï¿?0ï¿?6ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7
	key_down = key_value & (key_value ^ key_old); //ï¿?1ï¿?7ï¿?0ï¿?5ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7
	key_up = ~key_value & (key_value ^ key_old);  //ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7
	key_old = key_value;
	
	if(key_down)       //ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?73ï¿?1ï¿?7ï¿?1ï¿?7
		key_tick = 3000;
	
	 //key_oldï¿?1ï¿?7ï¿?1ï¿?7ï¿?0ï¿?5 tickï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?0ï¿?4ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7  longï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?0ï¿?8ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?0ï¿?1ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?0ï¿?5ï¿?1ï¿?7ï¿?1ï¿?7
	if(key_old && key_tick == 0 && keylong){
		keylong = 0;		
		if(key_old == 1){ 		//ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?0ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7		
			//------ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?71ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7--------
			
			//------ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?71ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7--------				
		}
		if(key_old == 4){ //ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?0ï¿?3ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7	
			//------ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?74ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7--------

			//------ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?74ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7--------		
		}
	}
	
	if(key_up) //keydown-keyupï¿?0ï¿?3ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?2ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7
		keylong = 1;
	
	if(key_tick && key_sw){
		switch(key_up)
		{
			case 1://ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?71
			{ 		
				if(++mode > 3) mode = 0;
				break;
			}
			case 2://ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?72
			{
				if(--mode == 0) mode = 0;
				break;
			}
			case 3://ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?73
			{
				Buzzer ^= 1;
				break;
			}
			case 4://ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?74
			{  
				mode++;
				break;                             
			}                            				 
			default:                             
				break;
		}
	}
		
}

//================ï¿?1ï¿?7ï¿?1ï¿?7ï¿?0ï¿?5ï¿?1ï¿?7ï¿?1ï¿?8ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7=======================
void Disp_Proc(void)  	   //LCD Dsiplay process function
{
	if(disp_slow_down) return;   //200msï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?0ï¿?5ï¿?1ï¿?7æ±›ï¿½0ï¿?0ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7(200msï¿?0ï¿?6ï¿?1ï¿?7ï¿?1ï¿?7ï¿?0ï¿?5ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?0ï¿?3)
		disp_slow_down = 1;
	
	sprintf(seg_string,"---%d",(unsigned int)mode); //ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7
	//sprintf(seg_string,"0001"); //ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7
	Led_Trans(seg_string,seg_buf1); 

	sprintf(seg_string,"----");
	Led_Trans(seg_string,seg_buf2); 
	
}

//================ï¿?1ï¿?7ï¿?0ï¿?8ï¿?1ï¿?7ï¿?1ï¿?7ð ¬ï¿?1ï¿?7ï¿?1ï¿?7=======================

//ï¿?1ï¿?7ï¿?1ï¿?7ï¿?0ï¿?2ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?0ï¿?2 ï¿?1ï¿?7ï¿?6ï¿?2ï¿?0ï¿?9ï¿?1ï¿?7ï¿?1ï¿?7ï¿?0ï¿?2ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?0ï¿?8ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7
void Delay(unsigned int delay) 
{
	delay_tick = delay;
	while(delay_tick > 0);
}

/*
tick: ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?0ï¿?2ï¿?1ï¿?7ï¿?1ï¿?7ms
*/
void Buzzer_Ctrl(u16 tick)  
{
	buzzer_tick = tick;
}

void Peripheral_Init(void)//ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?0ï¿?3ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7
{
	Buzzer_Ctrl(200);//ï¿?1ï¿?7ï¿?0ï¿?3ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7200msï¿?0ï¿?5ï¿?1ï¿?7ï¿?1ï¿?7
	LED_buf = 0x30;
 
}


//================ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?72ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?4ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7=======================

//========================================================================
// ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7: void PrintString2(u8 *puts)
// ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7: ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?72ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?0ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7
// ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7: puts:  ï¿?1ï¿?7ï¿?0ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?0ï¿?8ï¿?1ï¿?7ï¿?1ï¿?7.
// ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7: none.
// ï¿?1ï¿?7ç…?: VER1.0
// ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7: 2014-11-28
// ï¿?1ï¿?7ï¿?1ï¿?7ï¿?0ï¿?0: 
//========================================================================
void PrintString2(unsigned char *puts)
{
    for (; *puts != 0;  puts++)     //ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?0ï¿?5ï¿?0ï¿?9ï¿?1ï¿?7ï¿?1ï¿?70ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7
    {
        S2BUF = *puts;
        B_TX2_Busy = 1;
        while(B_TX2_Busy);
    }
}

//========================================================================
// ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7: SetTimer2Baudraye(u16 dat)
// ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7: ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7Timer2ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?0ï¿?8ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7
// ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7: dat: Timer2ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?0ï¿?4ï¿?0ï¿?5.
// ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7: none.
// ï¿?1ï¿?7ç…?: VER1.0
// ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7: 2014-11-28
// ï¿?1ï¿?7ï¿?1ï¿?7ï¿?0ï¿?0: 
//========================================================================
void SetTimer2Baudraye(unsigned int dat)  // ï¿?0ï¿?0ï¿?1ï¿?7ï¿?1ï¿?7Timer2ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7.
{
    AUXR &= ~(1<<4);    //Timer stop
    AUXR &= ~(1<<3);    //Timer2 set As Timer
    AUXR |=  (1<<2);    //Timer2 set as 1T mode
    T2H = dat / 256;
    T2L = dat % 256;
    IE2  &= ~(1<<2);    //ï¿?1ï¿?7ï¿?1ï¿?7ï¿?0ï¿?9ï¿?1ï¿?7å¿?ï¿?1ï¿?7
    AUXR |=  (1<<4);    //Timer run enable
}

//========================================================================
// ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7: void UART2_config(u8 brt)
// ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7: UART2ï¿?1ï¿?7ï¿?1ï¿?7ï¿?0ï¿?3ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7
// ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7: brt: ï¿?0ï¿?5ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7, 2: ï¿?0ï¿?0ï¿?1ï¿?7ï¿?1ï¿?7Timer2ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7, ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?0ï¿?5: ï¿?1ï¿?7ï¿?1ï¿?7å®?.
// ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7: none.
// ï¿?1ï¿?7ç…?: VER1.0
// ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7: 2014-11-28
// ï¿?1ï¿?7ï¿?1ï¿?7ï¿?0ï¿?0: 
//========================================================================
void UART2_config(unsigned char brt)    // ï¿?0ï¿?5ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7, 2: ï¿?0ï¿?0ï¿?1ï¿?7ï¿?1ï¿?7Timer2ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7, ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?0ï¿?5: ï¿?1ï¿?7ï¿?1ï¿?7å®?.
{
    /*********** ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?0ï¿?0ï¿?0ï¿?0ï¿?1ï¿?7ï¿?0ï¿?0ï¿?1ï¿?7ï¿?0ï¿?2ï¿?1ï¿?7ï¿?0ï¿?2ï¿?1ï¿?7ï¿?1ï¿?72 *****************/
    if(brt == 2)
    {
        SetTimer2Baudraye(65536UL - (MAIN_Fosc / 4) / Baudrate2);

        S2CON &= ~(1<<7);   // 8ç«¹ï¿½1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7, 1ç«¹ï¿½1ï¿?7ï¿?1ï¿?7ï¿?0ï¿?3ç«?, 1ç«¹ï¿½0ï¿?5ï¿?0ï¿?9ç«?, ï¿?1ï¿?7ï¿?1ï¿?7å­ï¿½1ï¿?7ï¿?1ï¿?7
        IE2   |= 1;         //ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7å¿?ï¿?1ï¿?7
        S2CON |= (1<<4);    //ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7
        P_SW2 &= ~0x01; 
        P_SW2 |= 0;         //UART2 switch to: 0: P1.0 P1.1,  1: P4.6 P4.7

        B_TX2_Busy = 0;
        TX2_Cnt = 0;
        RX2_Cnt = 0;
    }
}

//========================================================================
// ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7: void UART2_int (void) interrupt UART2_VECTOR
// ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7: UART2ï¿?1ï¿?7å¿?ï¿?0ï¿?8ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7
// ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7: nine.
// ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7: none.
// ï¿?1ï¿?7ç…?: VER1.0
// ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7ï¿?1ï¿?7: 2014-11-28
// ï¿?1ï¿?7ï¿?1ï¿?7ï¿?0ï¿?0: 
//========================================================================
void UART2_int (void) interrupt 8
{
    if((S2CON & 1) != 0)
    {
        S2CON &= ~1;    //Clear Rx flag
        RX2_Buffer[RX2_Cnt] = S2BUF;
        if(++RX2_Cnt >= UART2_BUF_LENGTH)   RX2_Cnt = 0;
    }

    if((S2CON & 2) != 0)
    {
        S2CON &= ~2;    //Clear Tx flag
        B_TX2_Busy = 0;
    }
}
